---
MEP: 2
Title: Local Variables
Discussion: XXX
Implementation: https://github.com/marimo-team/prototype/tree/local_variables
---

# Local Variables

## Abstract

This MEP proposes syntax and semantics for variables that are local to a cell.
Variables declared with a leading underscore, such as `_x` or `_`, are not
added to a cell's list of definitions, and are unavailable to other cells.

## Motivation

The rule against declaring the same global name in multiple cells can be
unwieldy, since some names may be declared at a cell's top-level scope but
meant only to be used within the cell as an internal or private variable.

**Underscore.**
An important example is the underscore identifier `_`, used to communicate that
a value is unused: e.g.,

```python
_, value = f()
```

**Loop variables.**
Another important example class are loop variables:

```python
for i in range(10):
   ...
```

Because scoping in Python is leaky, `i` becomes a global variable, even
though in most cases the programmer won't ever read `i` after the loop body.
This same problem arises in `with` statements.

**Temporaries.**
A name may be  used to bind to a temporary or intermediate value in a
computation to minimize redundant computation or for legibility of the code:

```python
b = X @ a
c = Y @ b
d = Z @ b
```

Here, perhaps `c` and `d` will be used by other cells, but `b` won't. 

## Proposed Syntax

Any name that begins with an underscore is treated as a local variable.

Examples:

**Unpacking.**

```python
_, value = f()
```

Here `_` starts with an underscore, so it is a local variable.

**Loop variables.**

```python
for _i in range(10):
   ...
```

**Temporaries.**

```python
_b = X @ a
c = Y @ _b
d = Z @ _b
```

### Representation in the generated module
Variables prefixed with `_` will not be included in the returns of a cell's
defining function.


## Discussion

The syntax follows the familiar idiom of using leading underscores to
designate a variable as private, and it includes the conventional use of `_` as
a temporary identifier as a special case.

It can be awkward or ugly to prefix variables with underscores. If a programmer finds
that they have to do this very often within the same cell, they could instead
opt to encapsulate their code within a function (which they may choose to make
local), removing the need to prefix the variables. In this way, the proposed
syntax may nudge programmers to modularize their code into functions.

## Alternatives Considered

**Variable annotation.** An alternative to name-based designation of locals
is to use a variable annotation, such as

```
i: mo.local
```

This may lead to more legible typography, since code will not be cluttered
with underscores. But it is unidiomatic, and does not cover the use of `_`
as a temporary identifier. Moreover, it leads to ambiguity in the case
that another cell declares `i` as a global varible.

**No local variables.** We could choose to not have any local variables, but
provide a special case for `_`. Users would then be very strongly encouraged to
encapsulate code in functions. But they wouldn't be able to make local
functions, pushing the naming problem from variables to functions.

## Implementation

- Modify the AST visitor to not include names starting with `_` in `defs` or `_refs`.
   - Include them in an attribute called `locals`
- Modify the runtime to prevent a cell's locals from leaking into the globals
  dictionary.
   - in `execute_cell`, after execution, remove all locals from the supplied
     `glbls` dict
