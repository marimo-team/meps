---
MEP: 2
Title: Local Variables
Discussion: XXX
Implementation: https://github.com/marimo-team/prototype/tree/local_variables
---

# Local Variables

## Abstract

This MEP proposes syntax and semantics for variables that are local to a cell.
Variables declared with a leading underscore, such as `_x` or `_`, are not
added to a cell's list of definitions, and are unavailable to other cells.

## Motivation

Reactivity solves many problems with existing notebooks / REPLs, in particular
the problems of inconsistent state and hidden state. The mechanism of
using global variables (variables declared in a cell's top-most scope) to
construct a dataflow graph is simple to understand and simple to use.

Tracking _every_ global variable, however, can become unwieldy. The programmer
may want to use some top-level variables as temporaries that are internal
or 'private' to the cell in which they are defined.

An important example is the underscore identifier `_`, used often in pattern
matching to communicate that a value is unimportant. For example, a function
`f` may return two values, but the programmer may want to use just the second
one:

```python
_, value = f()
```

Today, if this line were included in a cell's top-level scope, _no other cell
would be allowed to re-use this pattern_. This is clearly a problem.

Another important example class are loop variables:

```python
for i in range(10):
   ...
```

Because scoping in Python is leaky, `i` becomes a global variable. The
programmer almost certainly does not want this behavior. This same problem
arises in `with` statements.

Then there is the class of examples in which a name is used to bind to
a temporary or intermediate value in a computation, to minimize redundant
computation or for legibility of the code:

```python
b = X @ a
c = Y @ b
d = Z @ b
```

Here, perhaps `c` and `d` will be used by other cells, but `b` won't. 

## Proposed Syntax

Any name that begins with an underscore is treated as a local variable.

Examples:

**Pattern-matching.**

```python
_, value = f()
```

Here `_` starts with an underscore, so it is a local variable.

**Loop variables.**

```python
for _i in range(10):
   ...
```

```python
_b = X @ a
c = Y @ _b
d = Z @ _b
```


## Discussion

The syntax follows the idiom of using leading underscores to
designate a variable as private, so it should be familiar. A nice property of
this syntax is that it includes the use of `_` as a temporary identifier as a
special case.

It may be slightly awkward to prefix temporary variables, espcially loop
variables, with underscores. If a user finds that they have to do this
very often within the same cell, they could instead opt to encapsulate their
code within a function (which they may choose to make local), removing the need
to prefix the variables (since all variables declared in a function body are
in a local scope). In this way, the proposed syntax may encourage our users to
structure their apps as a collection of functions.

## Alternatives Considered

**Variable annotation.** An alternative to name-based designation of locals
is to use a variable annotation, such as

```
i: mo.local
```

This may lead to more legible typography, since code will not be cluttered
with underscores. But it is unidiomatic, and does not cover the use of `_`
as a temporary identifier. Moreover, it leads to ambiguity in the case
that another cell declares `i` as a global varible.

**No local variables.** We could choose to not have any local variables, and
provide a special case for `_`. Users will then be very strongly encouraged to
encapsulate code in functions. But then they won't be able to make temporary
functions ...

## Implementation
- Modify the AST visitor to not include locals in `defs` or `_refs`.
- Modify the runtime to prevent a cell's locals from leaking into the globals
  dictionary.
